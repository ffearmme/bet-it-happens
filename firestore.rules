rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Robust Admin Check
    function isAdmin() {
      return request.auth != null && (
        (request.auth.token.email != null && request.auth.token.email.lower().matches('.*admin.*')) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // ARENA GAMES
    match /arena_games/{gameId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null; // Players need to move and update state
      allow delete: if isAdmin();
    }

    // EVENTS
    match /events/{eventId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (
        request.auth != null &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastComment', 'stats'])
      );
    }
    
    // USERS
    match /users/{userId} {
      allow read: if true;
      
      // Create: user themselves or admin
      allow create: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Delete: Explicitly allow admins and the user themselves
      allow delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      allow update: if request.auth != null && (
        request.auth.uid == userId || 
        isAdmin() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['squadInvites']) ||
        (
          resource.data.squadId != null && // Must be in a squad
          get(/databases/$(database)/documents/squads/$(resource.data.squadId)).data.leaderId == request.auth.uid && // Requester must be leader of THAT squad
          (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['squadId']) ||
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['balance'])
          )
        ) ||
        // Allow P2P Settlement (Arena) - MVP Relaxed Rule
        // Allows users to update balances/stats of opponents when settling games
        (
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['balance', 'lockedBalance', 'invested', 'wins', 'losses'])
        )
      );
    }
    
    // BETS
    match /bets/{betId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if isAdmin();
      // Allow users to delete their own bets AND admins
      allow delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // CASINO BETS
    match /casino_bets/{betId} {
      allow read: if true;
      allow create: if request.auth != null && (request.resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // JACKPOTS
    match /jackpots/{jobId} {
      allow read: if request.auth != null;
      allow create: if isAdmin() || (request.auth != null && request.resource.data.userId == request.auth.uid);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // COMMENTS
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Allow users to delete their own comments AND admins
      allow delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      
      // Allow auth users to update 'likes' (for fire emoji)
      allow update: if request.auth != null && (
        isAdmin() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
      );
    }
    
    // NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read: if (request.auth != null && resource.data.userId == request.auth.uid) || isAdmin();
      allow create: if isAdmin() || (request.auth != null && (
        request.resource.data.type == 'referral' || 
        request.resource.data.type == 'referral_claim' || 
        request.resource.data.type == 'squad_invite' || 
        request.resource.data.type == 'squad_join' || 
        request.resource.data.type == 'squad_promotion' || 
        request.resource.data.type == 'squad_role_update' || 
        request.resource.data.type == 'squad_kick' || 
        request.resource.data.type == 'mod_concern' ||
        request.resource.data.type == 'arena_invite' ||
        request.resource.data.type == 'arena_accepted' ||
        request.resource.data.type == 'arena_turn' ||
        request.resource.data.type == 'arena_lost' ||
        request.resource.data.type == 'result' ||
        request.resource.data.type == 'system'
      ));
      allow update: if isAdmin() || (
        request.auth != null && 
        resource.data.userId == request.auth.uid &&
        // Allow users to update state (read/claimed) but NOT critical fields
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['amount', 'userId', 'type', 'createdAt', 'squadId', 'eventId'])
      );
      // Allow users to delete their own notifications AND admins
      allow delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // IDEAS
    match /ideas/{ideaId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Allow users to delete their own ideas AND admins
      allow delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow update: if isAdmin() || (
        request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['modRecommended', 'recommendedBy', 'recommendedAt'])
      );
    }

    // PARLAYS
    match /parlays/{parlayId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Added 'lastComment' to allowed update fields
      allow update: if request.auth != null && (
         isAdmin() ||
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['wagersCount', 'totalPool', 'lastComment', 'tailedBy'])
      );
      // Allow users to delete their own parlays AND admins
      allow delete: if isAdmin() || (request.auth != null && resource.data.creatorId == request.auth.uid);
    }

    // SQUADS
    match /squads/{squadId} {
      allow read: if true;
      
      // Create: Auth user
      allow create: if request.auth != null;

      // Update: Open to auth users for prototype (Join/Leave/Deposit/Withdraw)
      allow update: if request.auth != null; 

      allow delete: if isAdmin() || (request.auth != null && resource.data.leaderId == request.auth.uid);

      // Chat Messages
      match /messages/{messageId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid;
          // Add Admin delete capability for messages too, just in case
          allow delete: if isAdmin();
      }
    }

    // TRANSACTIONS
    match /transactions/{transId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || 
        isAdmin() || 
        resource.data.type == 'duel_join'
      );
      allow create: if request.auth != null;
      // Allow users to delete their own transactions AND admins
      allow delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // SYSTEM
    match /system/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
